#!/usr/bin/env bash

set -euo pipefail

CURRENT_DIR=$(realpath "$(dirname "${BASH_SOURCE[0]}")")

source "$CURRENT_DIR/core/ansi"
if ! command -v gum > /dev/null 2>&1; then
    ansi --red --bold "âš  gum TUI tool not found!" --newline
    ansi --newline
    ansi "Please run the minimal bootstrap first:" --newline
    ansi "  ./script/bootstrap" --newline
    ansi --newline
    ansi "Or install gum manually:" --newline
    ansi "  brew install gum" --newline
    exit 1
fi

if [ -z "${DOTFILES_PARENT_DIR:-}" ]; then
    DOTFILES_PARENT_DIR=$(dirname "$CURRENT_DIR")
    export DOTFILES_PARENT_DIR
fi

if [ -z "${DOTFILES_SESSION_ID:-}" ]; then
    DOTFILES_SESSION_ID="main-$(date +%Y%m%d-%H%M%S)"
    export DOTFILES_SESSION_ID
fi

mkdir -p "$DOTFILES_PARENT_DIR/tmp"

source "$CURRENT_DIR/core/common"
source "$CURRENT_DIR/core/system"
source "$CURRENT_DIR/core/prerequisites"
source "$CURRENT_DIR/core/ui"

main_menu() {
    while true; do
        show_standard_header
        show_section_header "SYSTEM OPERATIONS"

        local choice
        choice=$(gum choose \
            "[01] INIT SYSTEM" \
            "[02] PERFORM RESET" \
            "[03] UPDATE AND SYNC" \
            "[04] SYSTEM STATUS" \
            "[05] TERMINATE SESSION" \
            --height 6 \
            --cursor.foreground "$INTERFACE_COLOR" \
            --item.foreground "$INTERFACE_SECONDARY" \
            --selected.foreground "$INTERFACE_BG_COLOR" \
            --selected.background "$INTERFACE_COLOR" \
            --header="")

        case "$choice" in
            "[01] INIT SYSTEM")
                DOTFILES_PARENT_DIR="$DOTFILES_PARENT_DIR" "$CURRENT_DIR/setup"
                ;;
            "[02] PERFORM RESET")
                DOTFILES_PARENT_DIR="$DOTFILES_PARENT_DIR" "$CURRENT_DIR/reset"
                ;;
            "[03] UPDATE AND SYNC")
                DOTFILES_PARENT_DIR="$DOTFILES_PARENT_DIR" "$CURRENT_DIR/update"
                ;;
            "[04] SYSTEM STATUS")
                DOTFILES_PARENT_DIR="$DOTFILES_PARENT_DIR" "$CURRENT_DIR/status"
                ;;
            "[05] TERMINATE SESSION")
                show_exit_screen
                ;;
        esac
    done
}

info_log "Starting TUI interface"
main_menu
