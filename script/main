#!/usr/bin/env bash

# Main TUI Interface using gum for visual feedback
# Executes bootstrap scripts with rich visual elements and silent logging

set -euo pipefail

CURRENT_DIR=$(realpath "$(dirname "${BASH_SOURCE[0]}")")

# Source ansi helper for consistent output formatting
source "$CURRENT_DIR/core/ansi"

# Check if gum is available
if ! command -v gum > /dev/null 2>&1; then
    ansi --red --bold "âš  gum TUI tool not found!" --newline
    ansi --newline
    ansi "Please run the minimal bootstrap first:" --newline
    ansi "  ./script/bootstrap" --newline
    ansi --newline
    ansi "Or install gum manually:" --newline
    ansi "  brew install gum" --newline
    exit 1
fi

# Use existing variables from bootstrap if available, otherwise define them
if [ -z "${DOTFILES_PARENT_DIR:-}" ]; then
    DOTFILES_PARENT_DIR=$(dirname "$CURRENT_DIR")
    export DOTFILES_PARENT_DIR
fi

if [ -z "${DOTFILES_LOG_FILE:-}" ]; then
    DOTFILES_LOG_FILE="$DOTFILES_PARENT_DIR/tmp/main-$(date +%Y%m%d-%H%M%S).log"
    export DOTFILES_LOG_FILE
fi

if [ -z "${DOTFILES_DEBUG_LOG:-}" ]; then
    DOTFILES_DEBUG_LOG="$DOTFILES_PARENT_DIR/tmp/debug-main-$(date +%Y%m%d-%H%M%S).log"
    export DOTFILES_DEBUG_LOG
fi

# Ensure tmp directory exists
mkdir -p "$DOTFILES_PARENT_DIR/tmp"

# Import helpers
source "$CURRENT_DIR/core/common"
source "$CURRENT_DIR/core/system"
source "$CURRENT_DIR/core/prerequisites"
source "$CURRENT_DIR/core/ui"

# Main menu using gum
main_menu() {
    while true; do
        show_standard_header
        show_section_header "SYSTEM OPERATIONS"

        # Menu options
        local choice
        choice=$(gum choose \
            "[01] INIT SYSTEM" \
            "[02] UPDATE AND SYNC" \
            "[03] SYSTEM STATUS" \
            "[04] TERMINATE SESSION" \
            --height 6 \
            --cursor.foreground "$INTERFACE_COLOR" \
            --item.foreground "$INTERFACE_SECONDARY" \
            --selected.foreground "$INTERFACE_BG_COLOR" \
            --selected.background "$INTERFACE_COLOR" \
            --header="")

        case "$choice" in
            "[01] INIT SYSTEM")
                "$CURRENT_DIR/setup"
                ;;
            "[02] UPDATE AND SYNC")
                "$CURRENT_DIR/update"
                ;;
            "[03] SYSTEM STATUS")
                "$CURRENT_DIR/status"
                ;;
            "[04] TERMINATE SESSION")
                show_exit_screen
                ;;
        esac
    done
}

# Start the application
log_output "Starting TUI interface"
main_menu
