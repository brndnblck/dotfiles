#!/usr/bin/env bash
source "$(dirname "${BASH_SOURCE[0]}")/logging"


show_standard_header() {
    clear
    

    local git_tag
    git_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
    local git_hash
    git_hash=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
    local version_string
    if [ -n "$git_tag" ]; then

        local version_num
        version_num=$(echo "$git_tag" | sed 's/^v//')
        version_string="v${version_num}.${git_hash}"
    else
        version_string="v.${git_hash}"
    fi
    gum style \
        --foreground "$INTERFACE_SECONDARY" \
        "$INTERFACE_BOLD" \
        ">> BUILD: ${version_string}"
    

    colored_divider
    

    local title_color="${1:-$INTERFACE_SECONDARY}"
    gum style --foreground "$title_color" << 'EOF'
_______  .___________.  __________   __          __________     _______.
|       \ |           | /  /   ____||  |        /  /   ____|   /       |
|  .--.  |`---|  |----`/  /|  |__   |  |       /  /|  |__     |   (----`
|  |  |  |    |  |    /  / |   __|  |  |      /  / |   __|     \   \    
|  '--'  |    |  |   /  /  |  |     |  `----./  /  |  |____.----)   |   
|_______/     |__|  /__/   |__|     |_______/__/   |_______|_______/    
                                                                            
EOF
    
    ansi --newline
}


show_section_header() {
    local title="$1"
    
    gum style \
        --foreground "$INTERFACE_SECONDARY" \
        "$INTERFACE_BOLD" \
        ">> ${title}"
    
    colored_divider
    ansi --newline
}


show_completion() {
    local message="$1"
    
    ansi --newline
    gum style \
        --foreground "$INTERFACE_SECONDARY" \
        "$INTERFACE_BOLD" \
        --align center \
        ">> ${message}"
    
    colored_divider
}


show_footer_prompt() {

    ansi --newline
    gum input --placeholder "" \
        --cursor.foreground "$INTERFACE_COLOR" \
        --prompt.foreground "$INTERFACE_SECONDARY" \
        --prompt "▶ PRESS ENTER TO RETURN TO COMMAND INTERFACE "
}


COMPLETED_TASKS=()


run_with_progressive_spinner() {
    local message="$1"
    shift
    local command="$*"
    
    info_log "Starting: $message"
    
    # Log command to debug file
    debug_log "COMMAND: $command"
    

    if gum spin --spinner dot --title " $message" \
        --spinner.foreground "$INTERFACE_COLOR" \
        --title.foreground "$INTERFACE_COLOR" \
        -- bash -c "$command >> '${DOTFILES_LOG_FILE:-/tmp/bootstrap.log}' 2>&1"; then
        

        COMPLETED_TASKS+=("$message")
        

        echo "░ ✓ $message"
        
        # Also capture command output to debug log
        debug_log "COMMAND OUTPUT:"
        tail -n 50 "${DOTFILES_LOG_FILE:-/tmp/bootstrap.log}" >> "$(get_debug_log_file)"
        debug_log "END COMMAND OUTPUT"
        
        info_log "Completed: $message"
        return 0
    else
        # Log failure details to debug log
        debug_log "COMMAND FAILED: $command"
        debug_log "ERROR OUTPUT:"
        tail -n 50 "${DOTFILES_LOG_FILE:-/tmp/bootstrap.log}" >> "$(get_debug_log_file)"
        debug_log "END ERROR OUTPUT"
        
        error_log "Failed: $message"
        return 1
    fi
}


run_with_spinner() {
    local message="$1"
    shift
    local command="$*"
    
    info_log "Starting: $message"
    
    # Log command to debug file
    debug_log "COMMAND: $command"
    
    if gum spin --spinner dot --title " $message" \
        --spinner.foreground "$INTERFACE_COLOR" \
        --title.foreground "$INTERFACE_COLOR" \
        -- bash -c "$command >> '${DOTFILES_LOG_FILE:-/tmp/bootstrap.log}' 2>&1; echo \$? > /tmp/exit_code_\$\$"; then
        
        # Also capture command output to debug log
        debug_log "COMMAND OUTPUT:"
        tail -n 50 "${DOTFILES_LOG_FILE:-/tmp/bootstrap.log}" >> "$(get_debug_log_file)"
        debug_log "END COMMAND OUTPUT"
        
        info_log "Completed: $message"
        return 0
    else
        # Log failure details to debug log
        debug_log "COMMAND FAILED: $command"
        debug_log "ERROR OUTPUT:"
        tail -n 50 "${DOTFILES_LOG_FILE:-/tmp/bootstrap.log}" >> "$(get_debug_log_file)"
        debug_log "END ERROR OUTPUT"
        
        error_log "Failed: $message"
        return 1
    fi
}


show_error() {
    local message="$1"
    local exit_on_error="${2:-false}"
    
    error_log "$message"
    
    # Display error message with styling if gum is available
    if command -v gum >/dev/null 2>&1; then
        gum style --foreground "$INTERFACE_ERROR" "ERROR: $message"
    else
        echo "ERROR: $message" >&2
    fi
    
    if [ "$exit_on_error" = "true" ]; then
        exit 1
    fi
    
    return 1
}

show_exit_screen() {
    clear
    show_standard_header
    show_section_header "SYSTEM OPERATIONS"
    

    gum style --foreground "$INTERFACE_COLOR" "DISCONNECTING..."
    sleep 1
    ansi --newline
    gum style --foreground "$INTERFACE_SECONDARY" "/// SESSION TERMINATED [X]"
    ansi --newline
    
    exit 0
}