#!/usr/bin/env bash

set -euo pipefail

CURRENT_DIR=$(realpath "$(dirname "${BASH_SOURCE[0]}")")
DOTFILES_PARENT_DIR=$(dirname "$CURRENT_DIR")

DOTFILES_SESSION_ID="bootstrap-$(date +%Y%m%d-%H%M%S)"

export DOTFILES_SESSION_ID
export DOTFILES_PARENT_DIR

mkdir -p "$DOTFILES_PARENT_DIR/tmp"

source "$CURRENT_DIR/core/common"
source "$CURRENT_DIR/core/prerequisites"

info_log "Starting Dotfiles Bootstrap"

info_log "Running prerequisite checks..."
check_macos_version "13.0"
ensure_disk_encryption
ensure_command_line_tools
ensure_homebrew

if ! check_command "gum" "Gum TUI tool"; then
    info_log "Installing gum TUI tool..."
    silent "brew install gum" || show_error "Failed to install gum" "true"
    success_log "gum installed successfully"
else
    info_log "gum already available"
fi

success_log "Bootstrap complete! Launching main interface..."

clear

exec "$CURRENT_DIR/main"
