#!/usr/bin/env bash

set -euo pipefail

CURRENT_DIR=$(realpath "$(dirname "${BASH_SOURCE[0]}")")

source "$CURRENT_DIR/core/ansi"

if [ -z "${DOTFILES_PARENT_DIR:-}" ]; then
    ansi --red --bold "⚠ This script should not be called directly!" --newline
    ansi --newline
    ansi "Please use the main TUI interface:" --newline
    ansi "  ./script/main" --newline
    ansi --newline
    ansi "Or run the bootstrap first:" --newline
    ansi "  ./script/bootstrap" --newline
    exit 1
fi

if [ -z "${DOTFILES_PARENT_DIR:-}" ]; then
    DOTFILES_PARENT_DIR=$(dirname "$CURRENT_DIR")
fi
DOTFILES_SESSION_ID="update-$(date +%Y%m%d-%H%M%S)"
export DOTFILES_SESSION_ID
export DOTFILES_PARENT_DIR

mkdir -p "$DOTFILES_PARENT_DIR/tmp"

source "$CURRENT_DIR/core/logging"
source "$CURRENT_DIR/core/common"
source "$CURRENT_DIR/core/dependencies"
source "$CURRENT_DIR/core/ui"

main() {
    show_standard_header
    show_section_header "SYSTEM UPDATE"

    gum style \
        --foreground "$INTERFACE_COLOR" \
        --border normal \
        --border-foreground "$INTERFACE_SECONDARY" \
        --padding "0 1" \
        --width "$((INTERFACE_WIDTH - 1))" \
        "▶ UPDATE SEQUENCE:" \
        "" \
        "  [01] PACKAGE UPDATES" \
        "  [02] SYSTEM UPGRADES" \
        "  [03] APPLICATION UPDATES" \
        "  [04] CONFIGURATION SYNC" \
        "  [05] DEVELOPMENT TOOLS" \
        "  [06] SHELL ENVIRONMENT"

    ansi --newline

    if ! gum confirm "INITIATE UPDATE SEQUENCE?" \
        --prompt.foreground "$INTERFACE_COLOR" \
        --selected.foreground "$INTERFACE_BG_COLOR" \
        --selected.background "$INTERFACE_COLOR" \
        --unselected.foreground "$INTERFACE_COLOR" \
        --affirmative "EXECUTE" \
        --negative "ABORT"; then
        gum style --foreground "$INTERFACE_ERROR" "UPDATE SEQUENCE ABORTED"
        exit 0
    fi

    show_standard_header
    show_section_header "SYSTEM UPDATE"

    get_debug_log_file > /dev/null
    gum style --foreground "$INTERFACE_SECONDARY" "DEBUG: ${DOTFILES_DEBUG_LOG#"$DOTFILES_PARENT_DIR"/}"
    gum style --foreground "$INTERFACE_SECONDARY" "DEBUG LOG: $(get_debug_log_path)"
    ansi --newline

    export TASK_TITLE="SYSTEM UPDATE"

    if command -v brew > /dev/null 2>&1; then
        run_with_progressive_spinner "UPDATING PACKAGE REGISTRY..." \
            "brew update"

        run_with_progressive_spinner "UPGRADING PACKAGES..." \
            "brew upgrade"

        run_with_progressive_spinner "UPGRADING APPLICATIONS..." \
            "brew upgrade --cask"
    fi

    if command -v mas > /dev/null 2>&1; then
        run_with_progressive_spinner "UPDATING APP STORE APPS..." \
            "mas upgrade"
    fi

    if command -v chezmoi > /dev/null 2>&1; then

        if ! chezmoi source-path > /dev/null 2>&1; then
            info_log "Chezmoi not properly initialized, setting up..."
            run_with_progressive_spinner "INITIALIZING DOTFILE CONFIG..." \
                "chezmoi init --force --source '$DOTFILES_PARENT_DIR'"
        else

            current_source=$(chezmoi source-path 2> /dev/null || echo "")
            if [ -n "$current_source" ] && [ "$current_source" != "$DOTFILES_PARENT_DIR" ]; then

                if [ -L "$current_source" ] && [ "$(readlink "$current_source" 2> /dev/null || echo "")" = "$DOTFILES_PARENT_DIR" ]; then

                    info_log "Chezmoi source symlink verified"
                else
                    info_log "Chezmoi source path mismatch, reinitializing..."
                    run_with_progressive_spinner "REINITIALIZING DOTFILE CONFIG..." \
                        "chezmoi init --force --source '$DOTFILES_PARENT_DIR'"
                fi
            fi
        fi

        if [ -d "$DOTFILES_PARENT_DIR/.git" ]; then

            if ! run_with_progressive_spinner "SYNCING DOTFILE CONFIG..." \
                "chezmoi update 2>/dev/null"; then

                info_log "Update failed, applying current configuration..."
                run_with_progressive_spinner "APPLYING DOTFILE CONFIG..." \
                    "chezmoi apply --force"
            fi
        else

            run_with_progressive_spinner "APPLYING DOTFILE CONFIG..." \
                "chezmoi apply --force"
        fi

        run_with_progressive_spinner "REFRESHING SHELL ENVIRONMENT..." \
            "source '$CURRENT_DIR/core/system' && apply_dotfiles_and_shell"
    fi

    run_with_progressive_spinner "UPDATING DEVELOPMENT STACK..." \
        "export DOTFILES_PARENT_DIR='$DOTFILES_PARENT_DIR' && source '$CURRENT_DIR/core/common' && source '$CURRENT_DIR/core/dependencies' && update_development"

    run_with_progressive_spinner "SYNCHRONIZING PACKAGE DEPENDENCIES..." \
        "export DOTFILES_PARENT_DIR='$DOTFILES_PARENT_DIR' && source '$CURRENT_DIR/core/common' && source '$CURRENT_DIR/core/dependencies' && ensure_dependencies"

    run_with_progressive_spinner "SYNCHRONIZING APPLICATION REGISTRY..." \
        "export DOTFILES_PARENT_DIR='$DOTFILES_PARENT_DIR' && source '$CURRENT_DIR/core/common' && source '$CURRENT_DIR/core/dependencies' && ensure_applications"

    run_with_progressive_spinner "REFRESHING SYSTEM FONTS..." \
        "source '$CURRENT_DIR/core/system' && ensure_fonts"

    show_completion "SYSTEM UPDATE COMPLETE"
    show_footer_prompt
}

if [ "${BASH_SOURCE[0]}" = "${0}" ]; then
    main "$@"
fi
