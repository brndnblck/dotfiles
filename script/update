#!/usr/bin/env bash

# Dotfiles Update Script
# Updates all system packages and configurations

set -euo pipefail

CURRENT_DIR=$(realpath "$(dirname "${BASH_SOURCE[0]}")")

source "$CURRENT_DIR/core/ansi"

# Check if this script is being called directly (not through main TUI)
if [ -z "${DOTFILES_PARENT_DIR:-}" ]; then
    ansi --red --bold "⚠ This script should not be called directly!" --newline
    ansi --newline
    ansi "Please use the main TUI interface:" --newline
    ansi "  ./script/main" --newline
    ansi --newline
    ansi "Or run the bootstrap first:" --newline
    ansi "  ./script/bootstrap" --newline
    exit 1
fi
DOTFILES_PARENT_DIR=$(dirname "$CURRENT_DIR")
DOTFILES_SESSION_ID="update-$(date +%Y%m%d-%H%M%S)"
export DOTFILES_SESSION_ID
export DOTFILES_PARENT_DIR

# Ensure tmp directory exists
mkdir -p "$DOTFILES_PARENT_DIR/tmp"

# Import helpers
source "$CURRENT_DIR/core/logging"
source "$CURRENT_DIR/core/common"
source "$CURRENT_DIR/core/dependencies"
source "$CURRENT_DIR/core/ui"

# Main update function
main() {
    show_standard_header
    show_section_header "SYSTEM UPDATE"

    # Display log paths and update sequence
    gum style \
        --foreground "$INTERFACE_COLOR" \
        --border normal \
        --border-foreground "$INTERFACE_SECONDARY" \
        --padding "0 1" \
        --width "$((INTERFACE_WIDTH - 1))" \
        "▶ UPDATE SEQUENCE:" \
        "" \
        "  [01] PACKAGE UPDATES" \
        "  [02] SYSTEM UPGRADES" \
        "  [03] APPLICATION UPDATES" \
        "  [04] CONFIGURATION SYNC" \
        "  [05] DEVELOPMENT TOOLS" \
        "  [06] SHELL ENVIRONMENT"

    ansi --newline

    if ! gum confirm "INITIATE UPDATE SEQUENCE?" \
        --prompt.foreground "$INTERFACE_COLOR" \
        --selected.foreground "$INTERFACE_BG_COLOR" \
        --selected.background "$INTERFACE_COLOR" \
        --unselected.foreground "$INTERFACE_COLOR" \
        --affirmative "EXECUTE" \
        --negative "ABORT"; then
        gum style --foreground "$INTERFACE_ERROR" "UPDATE SEQUENCE ABORTED"
        exit 0
    fi

    # Transition to progress display
    show_standard_header
    show_section_header "SYSTEM UPDATE"

    # Display log paths (relative from DOTFILES_PARENT_DIR)
    gum style --foreground "$INTERFACE_SECONDARY" "DEBUG: ${DOTFILES_DEBUG_LOG#"$DOTFILES_PARENT_DIR"/}"
    gum style --foreground "$INTERFACE_SECONDARY" "DEBUG LOG: $(get_debug_log_path)"
    ansi --newline

    # Set task title for progress display
    export TASK_TITLE="SYSTEM UPDATE"

    # Update Homebrew
    if command -v brew > /dev/null 2>&1; then
        run_with_progressive_spinner "UPDATING PACKAGE REGISTRY..." \
            "brew update"

        run_with_progressive_spinner "UPGRADING PACKAGES..." \
            "brew upgrade"

        run_with_progressive_spinner "UPGRADING APPLICATIONS..." \
            "brew upgrade --cask"
    fi

    # Update Mac App Store apps
    if command -v mas > /dev/null 2>&1; then
        run_with_progressive_spinner "UPDATING APP STORE APPS..." \
            "mas upgrade"
    fi

    # Update dotfiles and sync configuration
    if command -v chezmoi > /dev/null 2>&1; then
        # Check if chezmoi is properly initialized
        if ! chezmoi source-path > /dev/null 2>&1; then
            info_log "Chezmoi not properly initialized, setting up..."
            run_with_progressive_spinner "INITIALIZING DOTFILE CONFIG..." \
                "chezmoi init --force --source '$DOTFILES_PARENT_DIR'"
        else
            # Verify the source path is correct
            current_source=$(chezmoi source-path 2> /dev/null || echo "")
            if [ -n "$current_source" ] && [ "$current_source" != "$DOTFILES_PARENT_DIR" ]; then
                # Check if it's a symlink pointing to our dotfiles
                if [ -L "$current_source" ] && [ "$(readlink "$current_source")" = "$DOTFILES_PARENT_DIR" ]; then
                    # Symlink is correct, proceed
                    :
                else
                    info_log "Chezmoi source path mismatch, reinitializing..."
                    run_with_progressive_spinner "REINITIALIZING DOTFILE CONFIG..." \
                        "chezmoi init --force --source '$DOTFILES_PARENT_DIR'"
                fi
            fi
        fi

        # Try update first (if in a git repo), fall back to apply if needed
        if [ -d "$DOTFILES_PARENT_DIR/.git" ]; then
            # We're in a git repository, try to update
            if ! run_with_progressive_spinner "SYNCING DOTFILE CONFIG..." \
                "chezmoi update 2>/dev/null"; then
                # Update failed, fall back to apply
                info_log "Update failed, applying current configuration..."
                run_with_progressive_spinner "APPLYING DOTFILE CONFIG..." \
                    "chezmoi apply --force"
            fi
        else
            # Not a git repository, just apply
            run_with_progressive_spinner "APPLYING DOTFILE CONFIG..." \
                "chezmoi apply --force"
        fi

        run_with_progressive_spinner "REFRESHING SHELL ENVIRONMENT..." \
            "source '$CURRENT_DIR/core/system' && apply_dotfiles_and_shell"
    fi

    # Update development tools
    run_with_progressive_spinner "UPDATING DEVELOPMENT STACK..." \
        "export DOTFILES_PARENT_DIR='$DOTFILES_PARENT_DIR' && source '$CURRENT_DIR/core/common' && source '$CURRENT_DIR/core/dependencies' && update_development"

    # Sync package dependencies and applications
    run_with_progressive_spinner "SYNCHRONIZING PACKAGE DEPENDENCIES..." \
        "export DOTFILES_PARENT_DIR='$DOTFILES_PARENT_DIR' && source '$CURRENT_DIR/core/common' && source '$CURRENT_DIR/core/dependencies' && ensure_dependencies"

    run_with_progressive_spinner "SYNCHRONIZING APPLICATION REGISTRY..." \
        "export DOTFILES_PARENT_DIR='$DOTFILES_PARENT_DIR' && source '$CURRENT_DIR/core/common' && source '$CURRENT_DIR/core/dependencies' && ensure_applications"

    # Update system components
    run_with_progressive_spinner "REFRESHING SYSTEM FONTS..." \
        "source '$CURRENT_DIR/core/system' && ensure_fonts"

    show_completion "SYSTEM UPDATE COMPLETE"
    show_footer_prompt
}

# Execute if called directly
if [ "${BASH_SOURCE[0]}" = "${0}" ]; then
    main "$@"
fi
